#!/usr/bin/env sh

set -eu

<% if options[:rails] -%>
# Run the app in production mode to ensure correct asset URLs are generated.
export RAILS_ENV=production

# Prevent most logs from outputting to stdout during a build.
export RAILS_LOG_LEVEL=warn

# Enable precompiling assets.
export SECRET_KEY_BASE=dummy
export SECRET_KEY_BASE_DUMMY=1

# If your Rails app uses ActiveRecord then this is a good point to create and
# seed the database from db/seeds.rb.
# bundle exec rails db:setup

# Generate production-optimised assets with Sprockets and friends. This must be
#Â done before generating the Parklife build as Rails will blow up if it detects
# missing assets in production.
bundle exec rails assets:precompile

<% elsif options[:sinatra] -%>
# Run the app in production mode.
export APP_ENV=production

<% end -%>
# Build with Parklife - and forward arguments sent to this script.
bundle exec parklife build "$@"

# Copy all public resources to ./build.
if [ -d public ]; then
  cp -R public/* build
fi

# List all files in the build (useful for debugging).
find build -type f | sort
